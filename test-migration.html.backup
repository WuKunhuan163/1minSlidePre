<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿ç§»åè½¬æ¢å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>è¿ç§»åè½¬æ¢å™¨æµ‹è¯•</h1>
    
    <div class="section">
        <h2>è½¬æ¢å™¨åˆå§‹åŒ–æµ‹è¯•</h2>
        <button onclick="testConverterInit()">æµ‹è¯•è½¬æ¢å™¨åˆå§‹åŒ–</button>
        <button onclick="testConverterMethods()">æµ‹è¯•è½¬æ¢å™¨æ–¹æ³•</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="testLog" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="testResults" class="log">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
    </div>

    <script type="module">
        let testResults = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateResults() {
            const resultsDiv = document.getElementById('testResults');
            const passed = testResults.filter(r => r.passed).length;
            const total = testResults.length;
            
            let html = `<div><strong>æµ‹è¯•ç»“æœ: ${passed}/${total} é€šè¿‡</strong></div>`;
            testResults.forEach(result => {
                const status = result.passed ? 'âœ…' : 'âŒ';
                const className = result.passed ? 'success' : 'error';
                html += `<div class="${className}">${status} ${result.name}: ${result.message}</div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function addResult(name, passed, message) {
            testResults.push({ name, passed, message });
            updateResults();
        }
        
        window.clearLog = function() {
            document.getElementById('testLog').innerHTML = '';
            testResults = [];
            updateResults();
        };
        
        // æµ‹è¯•è½¬æ¢å™¨åˆå§‹åŒ–
        window.testConverterInit = async function() {
            log('å¼€å§‹æµ‹è¯•è½¬æ¢å™¨åˆå§‹åŒ–...');
            
            try {
                // æµ‹è¯•æ¨¡å—å¯¼å…¥
                log('æµ‹è¯•æ¨¡å—å¯¼å…¥...');
                const { default: MigratedConverter } = await import('./modules/migrated-ffmpeg-converter.js');
                log('âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ', 'success');
                addResult('æ¨¡å—å¯¼å…¥', true, 'æˆåŠŸå¯¼å…¥MigratedOptimizedFFmpegConverter');
                
                // æµ‹è¯•å®ä¾‹åŒ–
                log('æµ‹è¯•å®ä¾‹åŒ–...');
                const converter = new MigratedConverter(false); // ä½¿ç”¨ç›´æ¥æ¨¡å¼é¿å…Workerå¤æ‚æ€§
                log('âœ… å®ä¾‹åŒ–æˆåŠŸ', 'success');
                addResult('å®ä¾‹åŒ–', true, 'æˆåŠŸåˆ›å»ºè½¬æ¢å™¨å®ä¾‹');
                
                // æµ‹è¯•æ–¹æ³•å­˜åœ¨æ€§
                log('æ£€æŸ¥å…³é”®æ–¹æ³•...');
                const requiredMethods = ['init', 'convertWebMToMP4', 'setLogCallback', 'setProgressCallback', 'destroy'];
                let methodsOk = true;
                
                for (const method of requiredMethods) {
                    if (typeof converter[method] === 'function') {
                        log(`âœ… æ–¹æ³• ${method} å­˜åœ¨`, 'success');
                    } else {
                        log(`âŒ æ–¹æ³• ${method} ä¸å­˜åœ¨`, 'error');
                        methodsOk = false;
                    }
                }
                
                addResult('æ–¹æ³•æ£€æŸ¥', methodsOk, methodsOk ? 'æ‰€æœ‰å¿…éœ€æ–¹æ³•éƒ½å­˜åœ¨' : 'éƒ¨åˆ†æ–¹æ³•ç¼ºå¤±');
                
                // æµ‹è¯•åˆå§‹åŒ–
                log('æµ‹è¯•è½¬æ¢å™¨åˆå§‹åŒ–...');
                converter.setLogCallback((message) => {
                    log(`[è½¬æ¢å™¨] ${message}`);
                });
                
                await converter.init();
                log('âœ… è½¬æ¢å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                addResult('åˆå§‹åŒ–', true, 'è½¬æ¢å™¨æˆåŠŸåˆå§‹åŒ–');
                
                // æµ‹è¯•çŠ¶æ€æ£€æŸ¥
                if (converter.isReady()) {
                    log('âœ… è½¬æ¢å™¨çŠ¶æ€æ­£å¸¸', 'success');
                    addResult('çŠ¶æ€æ£€æŸ¥', true, 'è½¬æ¢å™¨å¤„äºå°±ç»ªçŠ¶æ€');
                } else {
                    log('âŒ è½¬æ¢å™¨çŠ¶æ€å¼‚å¸¸', 'error');
                    addResult('çŠ¶æ€æ£€æŸ¥', false, 'è½¬æ¢å™¨æœªå¤„äºå°±ç»ªçŠ¶æ€');
                }
                
                // æ¸…ç†
                converter.destroy();
                log('ğŸ§¹ è½¬æ¢å™¨å·²æ¸…ç†');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult('åˆå§‹åŒ–æµ‹è¯•', false, `å¤±è´¥: ${error.message}`);
            }
        };
        
        // æµ‹è¯•è½¬æ¢å™¨æ–¹æ³•
        window.testConverterMethods = async function() {
            log('å¼€å§‹æµ‹è¯•è½¬æ¢å™¨æ–¹æ³•...');
            
            try {
                const { default: MigratedConverter } = await import('./modules/migrated-ffmpeg-converter.js');
                const converter = new MigratedConverter(false);
                
                converter.setLogCallback((message) => {
                    log(`[è½¬æ¢å™¨] ${message}`);
                });
                
                converter.setProgressCallback((percent) => {
                    log(`[è¿›åº¦] ${percent}%`);
                });
                
                await converter.init();
                
                // æµ‹è¯•getInfoæ–¹æ³•
                log('æµ‹è¯•getInfoæ–¹æ³•...');
                const info = converter.getInfo();
                log(`è½¬æ¢å™¨ä¿¡æ¯: ${JSON.stringify(info)}`);
                addResult('getInfoæ–¹æ³•', true, 'æˆåŠŸè·å–è½¬æ¢å™¨ä¿¡æ¯');
                
                // æµ‹è¯•getOptimalSettingsæ–¹æ³•
                log('æµ‹è¯•getOptimalSettingsæ–¹æ³•...');
                const settings = converter.getOptimalSettings(1024 * 1024); // 1MB
                log(`æœ€ä¼˜è®¾ç½®: ${JSON.stringify(settings)}`);
                addResult('getOptimalSettingsæ–¹æ³•', true, 'æˆåŠŸè·å–æœ€ä¼˜è®¾ç½®');
                
                // åˆ›å»ºæ¨¡æ‹ŸWebM blobè¿›è¡Œè½¬æ¢æµ‹è¯•ï¼ˆä¸æ‰§è¡Œå®é™…è½¬æ¢ï¼‰
                log('åˆ›å»ºæ¨¡æ‹ŸWebMæ•°æ®...');
                const mockWebmBlob = new Blob(['mock webm data'], { type: 'video/webm' });
                log('âœ… æ¨¡æ‹Ÿæ•°æ®åˆ›å»ºæˆåŠŸ', 'success');
                
                // æ³¨æ„ï¼šè¿™é‡Œä¸æ‰§è¡Œå®é™…è½¬æ¢ï¼Œå› ä¸ºéœ€è¦çœŸå®çš„WebMæ•°æ®
                log('âš ï¸ è·³è¿‡å®é™…è½¬æ¢æµ‹è¯•ï¼ˆéœ€è¦çœŸå®WebMæ•°æ®ï¼‰');
                addResult('æ¨¡æ‹Ÿæ•°æ®åˆ›å»º', true, 'æˆåŠŸåˆ›å»ºæ¨¡æ‹ŸWebMæ•°æ®');
                
                converter.destroy();
                log('âœ… æ–¹æ³•æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ æ–¹æ³•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult('æ–¹æ³•æµ‹è¯•', false, `å¤±è´¥: ${error.message}`);
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...');
            log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•è½¬æ¢å™¨åŠŸèƒ½');
        });
    </script>
</body>
</html>
