<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¬æ¢å™¨æ¥å£å¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .section {
            flex: 1;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .full-width {
            flex: none;
            width: 100%;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
        video {
            width: 100%;
            max-width: 300px;
            height: auto;
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            border-radius: 10px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>è½¬æ¢å™¨æ¥å£å¯¹æ¯”æµ‹è¯•</h1>
    
    <div class="section full-width">
        <h2>æ‘„åƒå¤´é¢„è§ˆ</h2>
        <video id="cameraPreview" autoplay muted></video>
        <div>
            <button onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
            <button onclick="stopCamera()">åœæ­¢æ‘„åƒå¤´</button>
        </div>
    </div>
    
    <div class="container">
        <div class="section">
            <h2>å‚è€ƒé¡¹ç›®è½¬æ¢å™¨</h2>
            <button onclick="recordAndConvertReference()" id="refRecordBtn">å½•åˆ¶5ç§’å¹¶è½¬æ¢</button>
            <div class="progress">
                <div class="progress-bar" id="refProgress" style="width: 0%"></div>
            </div>
            <div id="refLog" class="log">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
            <video id="refVideo" controls style="display: none;"></video>
        </div>
        
        <div class="section">
            <h2>è¿ç§»åè½¬æ¢å™¨</h2>
            <button onclick="recordAndConvertMigrated()" id="migRecordBtn">å½•åˆ¶5ç§’å¹¶è½¬æ¢</button>
            <div class="progress">
                <div class="progress-bar" id="migProgress" style="width: 0%"></div>
            </div>
            <div id="migLog" class="log">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
            <video id="migVideo" controls style="display: none;"></video>
        </div>
    </div>
    
    <div class="section full-width">
        <h2>å¯¹æ¯”ç»“æœ</h2>
        <div id="comparisonResult" class="log">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œå¯¹æ¯”æµ‹è¯•</div>
    </div>

    <script type="module">
        let cameraStream = null;
        let referenceConverter = null;
        let migratedConverter = null;
        let comparisonResults = [];
        
        // æ—¥å¿—å‡½æ•°
        function log(containerId, message, type = 'info') {
            const logDiv = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progressId, percent) {
            document.getElementById(progressId).style.width = percent + '%';
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function initCamera() {
            if (cameraStream) return cameraStream;
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: true 
                });
                document.getElementById('cameraPreview').srcObject = cameraStream;
                return cameraStream;
            } catch (error) {
                throw new Error(`æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // å¯åŠ¨æ‘„åƒå¤´ï¼ˆæ‰‹åŠ¨è°ƒç”¨ï¼‰
        window.startCamera = async function() {
            try {
                await initCamera();
                log('refLog', 'âœ… æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ', 'success');
                log('migLog', 'âœ… æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ', 'success');
            } catch (error) {
                log('refLog', `âŒ ${error.message}`, 'error');
                log('migLog', `âŒ ${error.message}`, 'error');
            }
        };
        
        // åœæ­¢æ‘„åƒå¤´
        window.stopCamera = function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                document.getElementById('cameraPreview').srcObject = null;
                
                document.getElementById('refRecordBtn').disabled = true;
                document.getElementById('migRecordBtn').disabled = true;
                
                log('refLog', 'ğŸ“¹ æ‘„åƒå¤´å·²åœæ­¢');
                log('migLog', 'ğŸ“¹ æ‘„åƒå¤´å·²åœæ­¢');
            }
        };
        
        
        // å½•åˆ¶å¹¶è½¬æ¢ - å‚è€ƒé¡¹ç›®
        window.recordAndConvertReference = async function() {
            
            const btn = document.getElementById('refRecordBtn');
            btn.disabled = true;
            
            try {
                // è‡ªåŠ¨åˆå§‹åŒ–æ‘„åƒå¤´
                log('refLog', 'ğŸ”§ åˆå§‹åŒ–æ‘„åƒå¤´...');
                updateProgress('refProgress', 5);
                await initCamera();
                log('refLog', 'âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è‡ªåŠ¨åˆå§‹åŒ–è½¬æ¢å™¨
                if (!referenceConverter) {
                    log('refLog', 'ğŸ”§ åˆå§‹åŒ–å‚è€ƒé¡¹ç›®è½¬æ¢å™¨...');
                    updateProgress('refProgress', 10);
                    
                    const { default: OptimizedFFmpegConverter } = await import('./webm_to_mp4/modules/ffmpeg-converter-optimized.js');
                    referenceConverter = new OptimizedFFmpegConverter(false);
                    
                    referenceConverter.setLogCallback((message) => {
                        log('refLog', `[å‚è€ƒè½¬æ¢å™¨] ${message}`);
                    });
                    
                    referenceConverter.setProgressCallback((percent) => {
                        updateProgress('refProgress', 30 + percent * 0.6);
                    });
                    
                    await referenceConverter.init();
                    log('refLog', 'âœ… è½¬æ¢å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                }
                
                log('refLog', 'ğŸ“¹ å¼€å§‹å½•åˆ¶ 5 ç§’...');
                updateProgress('refProgress', 20);
                
                const mediaRecorder = new MediaRecorder(cameraStream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                const chunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    try {
                        updateProgress('refProgress', 20);
                        const webmBlob = new Blob(chunks, { type: 'video/webm' });
                        log('refLog', `ğŸ“¹ å½•åˆ¶å®Œæˆï¼Œæ–‡ä»¶å¤§å°: ${(webmBlob.size/1024/1024).toFixed(2)}MB`);
                        
                        log('refLog', 'ğŸ”„ å¼€å§‹è½¬æ¢...');
                        updateProgress('refProgress', 30);
                        
                        const startTime = Date.now();
                        const mp4Blob = await referenceConverter.convertWebMToMP4(webmBlob);
                        const convertTime = ((Date.now() - startTime) / 1000).toFixed(2);
                        
                        log('refLog', `âœ… è½¬æ¢å®Œæˆï¼è€—æ—¶ ${convertTime} ç§’ï¼Œè¾“å‡ºå¤§å°: ${(mp4Blob.size/1024/1024).toFixed(2)}MB`, 'success');
                        updateProgress('refProgress', 100);
                        
                        // æ˜¾ç¤ºè½¬æ¢åçš„è§†é¢‘
                        const refVideo = document.getElementById('refVideo');
                        refVideo.src = URL.createObjectURL(mp4Blob);
                        refVideo.style.display = 'block';
                        
                        comparisonResults.push({
                            test: 'å½•åˆ¶è½¬æ¢æµ‹è¯•',
                            reference: `æˆåŠŸ (${convertTime}s, ${(mp4Blob.size/1024/1024).toFixed(2)}MB)`,
                            migrated: 'å¾…æµ‹è¯•'
                        });
                        
                    } catch (error) {
                        log('refLog', `âŒ è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                        comparisonResults.push({
                            test: 'å½•åˆ¶è½¬æ¢æµ‹è¯•',
                            reference: `å¤±è´¥: ${error.message}`,
                            migrated: 'å¾…æµ‹è¯•'
                        });
                    }
                    updateComparisonResults();
                };
                
                mediaRecorder.start();
                
                // 5ç§’ååœæ­¢å½•åˆ¶
                setTimeout(() => {
                    mediaRecorder.stop();
                }, 5000);
                
            } catch (error) {
                log('refLog', `âŒ å½•åˆ¶å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };
        
        // å½•åˆ¶å¹¶è½¬æ¢ - è¿ç§»ç‰ˆæœ¬
        window.recordAndConvertMigrated = async function() {
            const btn = document.getElementById('migRecordBtn');
            btn.disabled = true;
            
            try {
                // è‡ªåŠ¨åˆå§‹åŒ–æ‘„åƒå¤´
                log('migLog', 'ğŸ”§ åˆå§‹åŒ–æ‘„åƒå¤´...');
                updateProgress('migProgress', 5);
                await initCamera();
                log('migLog', 'âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è‡ªåŠ¨åˆå§‹åŒ–è½¬æ¢å™¨
                if (!migratedConverter) {
                    log('migLog', 'ğŸ”§ åˆå§‹åŒ–è¿ç§»åè½¬æ¢å™¨...');
                    updateProgress('migProgress', 10);
                    
                    const { default: MigratedConverter } = await import('./modules/migrated-ffmpeg-converter.js');
                    migratedConverter = new MigratedConverter(false);
                    
                    migratedConverter.setLogCallback((message) => {
                        log('migLog', `[è¿ç§»è½¬æ¢å™¨] ${message}`);
                    });
                    
                    migratedConverter.setProgressCallback((percent) => {
                        updateProgress('migProgress', 30 + percent * 0.6);
                    });
                    
                    await migratedConverter.init();
                    log('migLog', 'âœ… è½¬æ¢å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                }
                
                log('migLog', 'ğŸ“¹ å¼€å§‹å½•åˆ¶ 5 ç§’...');
                updateProgress('migProgress', 20);
                
                const mediaRecorder = new MediaRecorder(cameraStream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                const chunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    try {
                        updateProgress('migProgress', 20);
                        const webmBlob = new Blob(chunks, { type: 'video/webm' });
                        log('migLog', `ğŸ“¹ å½•åˆ¶å®Œæˆï¼Œæ–‡ä»¶å¤§å°: ${(webmBlob.size/1024/1024).toFixed(2)}MB`);
                        
                        log('migLog', 'ğŸ”„ å¼€å§‹è½¬æ¢...');
                        updateProgress('migProgress', 30);
                        
                        const startTime = Date.now();
                        const mp4Blob = await migratedConverter.convertWebMToMP4(webmBlob);
                        const convertTime = ((Date.now() - startTime) / 1000).toFixed(2);
                        
                        log('migLog', `âœ… è½¬æ¢å®Œæˆï¼è€—æ—¶ ${convertTime} ç§’ï¼Œè¾“å‡ºå¤§å°: ${(mp4Blob.size/1024/1024).toFixed(2)}MB`, 'success');
                        updateProgress('migProgress', 100);
                        
                        // æ˜¾ç¤ºè½¬æ¢åçš„è§†é¢‘
                        const migVideo = document.getElementById('migVideo');
                        migVideo.src = URL.createObjectURL(mp4Blob);
                        migVideo.style.display = 'block';
                        
                        // æ›´æ–°å¯¹æ¯”ç»“æœ
                        const existingResult = comparisonResults.find(r => r.test === 'å½•åˆ¶è½¬æ¢æµ‹è¯•');
                        if (existingResult) {
                            existingResult.migrated = `æˆåŠŸ (${convertTime}s, ${(mp4Blob.size/1024/1024).toFixed(2)}MB)`;
                        } else {
                            comparisonResults.push({
                                test: 'å½•åˆ¶è½¬æ¢æµ‹è¯•',
                                reference: 'å¾…æµ‹è¯•',
                                migrated: `æˆåŠŸ (${convertTime}s, ${(mp4Blob.size/1024/1024).toFixed(2)}MB)`
                            });
                        }
                        
                    } catch (error) {
                        log('migLog', `âŒ è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                        const existingResult = comparisonResults.find(r => r.test === 'å½•åˆ¶è½¬æ¢æµ‹è¯•');
                        if (existingResult) {
                            existingResult.migrated = `å¤±è´¥: ${error.message}`;
                        } else {
                            comparisonResults.push({
                                test: 'å½•åˆ¶è½¬æ¢æµ‹è¯•',
                                reference: 'å¾…æµ‹è¯•',
                                migrated: `å¤±è´¥: ${error.message}`
                            });
                        }
                    }
                    updateComparisonResults();
                };
                
                mediaRecorder.start();
                
                // 5ç§’ååœæ­¢å½•åˆ¶
                setTimeout(() => {
                    mediaRecorder.stop();
                }, 5000);
                
            } catch (error) {
                log('migLog', `âŒ å½•åˆ¶å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        };
        
        // æ›´æ–°å¯¹æ¯”ç»“æœ
        function updateComparisonResults() {
            const resultsDiv = document.getElementById('comparisonResult');
            
            let html = '<h3>æ¥å£å¯¹æ¯”ç»“æœ</h3>';
            html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
            html += '<tr><th>æµ‹è¯•é¡¹ç›®</th><th>å‚è€ƒé¡¹ç›®</th><th>è¿ç§»ç‰ˆæœ¬</th><th>å¯¹æ¯”ç»“æœ</th></tr>';
            
            comparisonResults.forEach(result => {
                const refSuccess = result.reference.includes('æˆåŠŸ');
                const migSuccess = result.migrated.includes('æˆåŠŸ');
                
                let comparison = '';
                if (refSuccess && migSuccess) {
                    comparison = '<span class="success">âœ… éƒ½æˆåŠŸ</span>';
                } else if (refSuccess && !migSuccess) {
                    comparison = '<span class="error">âŒ è¿ç§»ç‰ˆæœ¬å¤±è´¥</span>';
                } else if (!refSuccess && migSuccess) {
                    comparison = '<span class="warning">âš ï¸ å‚è€ƒé¡¹ç›®å¤±è´¥</span>';
                } else {
                    comparison = '<span class="error">âŒ éƒ½å¤±è´¥</span>';
                }
                
                html += `<tr>
                    <td>${result.test}</td>
                    <td>${result.reference}</td>
                    <td>${result.migrated}</td>
                    <td>${comparison}</td>
                </tr>`;
            });
            
            html += '</table>';
            resultsDiv.innerHTML = html;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('refLog', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...');
            log('migLog', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•...');
        });
    </script>
</body>
</html>
