# WebM to MP4 转换性能优化

## 优化目标
将转换速度从 0.25x 提升到接近 0.8x（参考对比项目的性能）

## 主要优化措施

### 1. 智能参数优化
- **CRF 值调整**: 从过于激进的 38 调整到更平衡的 30-35
- **音频比特率优化**: 统一使用 32k-64k，避免过低的 24k
- **采样率优化**: 从 16kHz 提升到 22.05kHz，平衡质量和性能

### 2. FFmpeg 参数简化
**移除的复杂参数:**
```bash
# 移除了这些降低性能的复杂 x264 参数
-x264-params ref=1:me=dia:subme=1:mixed-refs=0:trellis=0:weightp=0:weightb=0:8x8dct=0:fast-pskip=1
-r 30
-vsync cfr
-fps_mode cfr
-sc_threshold 40
```

**保留的高效参数:**
```bash
-preset ultrafast
-crf 32
-g 60          # 更大的GOP提升速度
-bf 0          # 禁用B帧
```

### 3. 音频处理优化
- **单声道处理**: `-ac 1` 减少音频处理开销
- **优化采样率**: `-ar 22050` 平衡质量和速度
- **降低比特率**: 合成模式使用 64k，普通转换使用 32k

### 4. 场景检测简化
- **移除复杂检测**: 不再进行耗时的场景变化分析
- **固定裁剪**: 使用固定的 0.1 秒裁剪代替动态检测
- **大幅减少处理时间**: 避免了 `detectVideoStart` 的复杂计算

### 5. 合成模式优化
- **预设优化**: 统一使用 `ultrafast` 预设
- **质量平衡**: CRF 从 23 调整到 32
- **音频简化**: 单声道 + 降低比特率

## 优化文件列表
1. `modules/ffmpeg-converter-optimized.js` - 主转换器优化
2. `modules/ffmpeg-worker.js` - Worker 模式优化

## 预期性能提升
- **普通转换**: 从 0.25x 提升到 0.6-0.8x
- **合成模式**: 大幅减少场景检测时间
- **整体用户体验**: 更快的转换速度，更少的等待时间

## 质量权衡
- **视频质量**: 轻微降低（CRF 32 vs 23），但仍保持可接受水平
- **音频质量**: 单声道 + 较低采样率，适合演讲录制场景
- **文件大小**: 可能略有增加，但转换速度大幅提升

## 测试建议
1. 测试不同长度的视频转换速度
2. 验证输出质量是否满足需求
3. 对比优化前后的转换时间
4. 确认演讲者模式合成功能正常

## 回滚方案
如需回滚，可以通过 git 恢复到优化前的版本：
```bash
git checkout HEAD~1 -- modules/ffmpeg-converter-optimized.js modules/ffmpeg-worker.js
```
